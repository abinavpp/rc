#! /bin/bash

function raw_tty() {
  ! dumpkeys &> /dev/null && return 1;
  local keymap=`dumpkeys | head -n 1`
  cat <<E > ~/.cache/mytty.map
$keymap
keycode 58 = Escape
keycode 1 = Caps_Lock
keycode 56 = SCtrl
keycode 100 = SAlt
keycode 42 = SShift
keycode 54 = SShift
# keycode 125 = SMeta
E
  loadkeys ~/.cache/mytty.map
}

function xmap() {
  local src=$1 dst=$2
  local map=`cat /usr/share/X11/xkb/keycodes/evdev | grep "$src"`
  [[ -z $map ]] && return
  local kc=`echo $map | awk '{print $3}' | sed 's/.$//'`
  xmodmap -e "keycode $kc = $dst"
}

function xmm() {
  local a
  for a in "$@"; do
    xmodmap -e "$a"
  done
}

function depr_x() {
  xkbset sticky -twokey
  xkbset exp 1 =sticky
  setxkbmap -option caps:swapescape
  xmm "clear control" "clear mod1"
  xmm "keycode 64 = Control_L" "keycode 135 = Alt_L Meta_L"
  xmm "add control = Control_L Control_R" "add mod1 = Alt_L Meta_L"
}

function x() {
  xkbset sticky -twokey
  xkbset exp 1 =sticky
  setxkbmap -option caps:swapescape
  xmm "clear control" "clear mod1"
  xmap '<LALT>' 'Control_L';
  xmap '<COMP>' 'Alt_L Meta_L';
  xmm "add control = Control_L" "add mod1 = Alt_L Meta_L"
}

run=$1; shift

if [[ $run == 'tty' ]]; then
  raw_tty
elif [[ $run == 'x' ]]; then
  x
fi
