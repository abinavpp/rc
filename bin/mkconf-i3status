#! /bin/bash

function write_temperature {
  path=$(find /sys/devices/platform/coretemp.0/hwmon/ \
    -name temp1_input -print -quit)
  [ -n "$path" ] || return

  cat <<EOF
cpu_temperature 0 {
  format = "%degrees °C"
  max_threshold = "75"
  path = $path
}
EOF
}

function write_order_temperature {
  path=$(find /sys/devices/platform/coretemp.0/hwmon/ \
    -name temp1_input -print -quit)
  [ -n "$path" ] && echo "order += \"cpu_temperature 0\""
}

function is_memory_supported {
  local curr_ver=$(i3status --version | awk '{print $2}') min_ver="2.13"

  [[ $curr_ver == $min_ver ]] && return 0

  # if curr_ver < min_ver
  if [[ $curr_ver == $(echo -e "$curr_ver\n$min_ver" \
    | sort -V | head -n1) ]]; then
    return 1
  fi

  return 0
}

function write_memory {
  ! is_memory_supported && return

cat <<ENDCAT
memory {
  format = "M: %available"
  threshold_degraded = "1G"
  format_degraded = "MEMORY < %available"
}

ENDCAT
}

function write_order_memory {
  is_memory_supported && echo "order += \"memory\""
}

function write_order_volume {
  [[ -d /proc/asound ]] && echo "order += \"volume master\""
}

function write_volume {
  [[ ! -d /proc/asound ]] && return

cat <<ENDCAT
volume master {
  format = "♪: %volume"
  format_muted = "♪: muted (%volume)"
  device = "default"
}

ENDCAT
}

mkdir -p $HOME/.config/i3status
exec > $HOME/.config/i3status/config

cat <<ENDCAT
# i3status configuration file.
# see "man i3status" for documentation.

# It is important that this file is edited as UTF-8.
# The following line should contain a sharp s:
# ß
# If the above line is not correctly displayed, fix your editor first!

# Generated by mkconf-i3status.

general {
  colors = true
  interval = 1
}

order += "tztime local"
order += "ipv6"
order += "wireless _first_"
order += "ethernet _first_"
order += "disk /"
order += "battery all"
order += "cpu_usage"
ENDCAT

write_order_memory
write_order_temperature
write_order_volume

cat <<ENDCAT

tztime local {
  format = "%Y-%m-%d [%a] %H:%M:%S"
}

ipv6 {
  format_down = ""
}

wireless _first_ {
  format_up = "W: (%quality at %essid) %ip"
  format_down = ""
}

ethernet _first_ {
  format_up = "E: %ip (%speed)"
  format_down = ""
}

disk "/" {
  format = "/: %avail"
}

battery all {
  format = "%status %percentage %remaining"
  format_down = ""
}

cpu_usage {
  format = "C: %usage"
}

ENDCAT

write_memory
write_volume
write_temperature
