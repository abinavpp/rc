#! /bin/bash

path_hwmon="/sys/class/hwmon"

function write_temperature {
  local count=0
  local hwmon_i temperature

  for hwmon_i in $path_hwmon/*; do
    if [[ -d $hwmon_i ]]; then
      # consider only the first temp*_input
      temp_input=`ls $hwmon_i/temp*_input 2> /dev/null | head -n1`
      if [[ ! -e $temp_input ]]; then
        continue;
      fi

      ((++count))
      [[ $1 == "get_count" ]] && continue;

      echo "cpu_temperature $((count - 1)) {"
      echo -e "\tformat = \"%degrees Â°C\"" # echo -e "\u00B0"
      echo -e "\tmax_threshold = \"75\""
      echo -e "\tpath = \"$temp_input\""
      echo -e "}\n"
    fi
  done

  if [[ $1 == "get_count" ]]; then
    echo $((count))
  fi
}

function write_order_temperature {
  local n=$(write_temperature get_count)
  for ((i = 0; i < $n; i++)) do
    echo "order += \"cpu_temperature $i\""
  done
}

function is_memory_supported {
  local curr_ver=$(i3status --version | awk '{print $2}') min_ver="2.13"

  [[ $curr_ver == $min_ver ]] && return 0

  # if curr_ver < min_ver
  if [[ $curr_ver == $(echo -e "$curr_ver\n$min_ver" \
    | sort -V | head -n1) ]]; then
    return 1
  fi

  return 0
}

function write_memory {
  ! is_memory_supported && return

cat <<ENDCAT
memory {
  format = "M: %available"
  threshold_degraded = "1G"
  format_degraded = "MEMORY < %available"
}

ENDCAT
}

function write_order_memory {
  is_memory_supported && echo "order += \"memory\""
}

function write_order_volume {
  [[ -d /proc/asound ]] && echo "order += \"volume master\""
}

function write_volume {
  [[ ! -d /proc/asound ]] && return

cat <<ENDCAT
volume master {
  format = "â™ª: %volume"
  format_muted = "â™ª: muted (%volume)"
  device = "default"
}

ENDCAT
}

mkdir -p $HOME/.config/i3status
exec > $HOME/.config/i3status/config

cat <<ENDCAT
# i3status configuration file.
# see "man i3status" for documentation.

# It is important that this file is edited as UTF-8.
# The following line should contain a sharp s:
# ÃŸ
# If the above line is not correctly displayed, fix your editor first!

# Generated by mkconf-i3status.

general {
  colors = true
  interval = 1
}

order += "tztime local"
order += "ipv6"
order += "wireless _first_"
order += "ethernet _first_"
order += "disk /"
order += "battery all"
order += "cpu_usage"
ENDCAT

write_order_memory
write_order_temperature
write_order_volume

cat <<ENDCAT

tztime local {
  format = "%Y-%m-%d [%a] %H:%M:%S"
}

ipv6 {
  format_down = ""
}

wireless _first_ {
  format_up = "W: (%quality at %essid) %ip"
  format_down = ""
}

ethernet _first_ {
  format_up = "E: %ip (%speed)"
  format_down = ""
}

disk "/" {
  format = "ðŸ–´ %avail"
}

battery all {
  format = "%status %percentage %remaining"
  format_down = ""
}

cpu_usage {
  format = "C: %usage"
}

ENDCAT

write_memory
write_volume
write_temperature
